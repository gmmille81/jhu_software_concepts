name: Tests

on:
  push:
    paths:
      - "module_4/**"
      - ".github/workflows/tests.yml"
  pull_request:
    paths:
      - "module_4/**"
      - ".github/workflows/tests.yml"

jobs:
  pytest:
    runs-on: ubuntu-latest

    env:
      PGHOST: ${{ vars.PGHOST }}
      PGPORT: ${{ vars.PGPORT }}
      PGDATABASE: ${{ vars.PGDATABASE }}
      PGUSER: ${{ vars.PGUSER }}
      PGPASSWORD: ${{ secrets.PGPASSWORD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        working-directory: module_4
        run: |
          python -m pip install --upgrade pip
          pip install -r src/requirements.txt pytest

      - name: Validate DB env
        run: |
          test -n "$PGHOST"
          test -n "$PGPORT"
          test -n "$PGDATABASE"
          test -n "$PGUSER"
          test -n "$PGPASSWORD"

      - name: Install and configure PostgreSQL (no Docker)
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql postgresql-contrib
          sudo systemctl start postgresql
          sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='${PGUSER}'" | grep -q 1 || sudo -u postgres createuser "$PGUSER"
          sudo -u postgres psql -v ON_ERROR_STOP=1 -c "ALTER USER \"$PGUSER\" WITH PASSWORD '$PGPASSWORD';"
          sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='${PGDATABASE}'" | grep -q 1 || sudo -u postgres createdb "$PGDATABASE"
          pg_isready -h "$PGHOST" -p "$PGPORT" -U "$PGUSER"

      - name: Run pytest suite
        working-directory: module_4
        run: pytest -q tests
